# è§£æé”™è¯¯å¤„ç†æŒ‡å—

## ğŸ“‹ é—®é¢˜è¯Šæ–­

å½“å‘ç°è§£æé”™è¯¯æ—¶ï¼Œé¦–å…ˆéœ€è¦ç¡®è®¤ï¼š
1. æ˜¯ LLM è§£æé”™è¯¯ï¼ˆç†è§£é”™è¯¯ã€OCR é”™è¯¯ï¼‰
2. è¿˜æ˜¯åŸå§‹ PDF æ•°æ®æœ¬èº«æœ‰è¯¯

## ğŸ”§ å¤„ç†æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šæ‰‹åŠ¨ä¿®æ­£ parsed_jsonï¼ˆæ¨èï¼Œå¿«é€Ÿï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å°èŒƒå›´æ•°æ®é”™è¯¯
- åŸå› æ˜ç¡®ï¼ˆå¦‚ OCR é”™è¯¯ã€LLM è¯¯è¯»ï¼‰
- éœ€è¦å¿«é€Ÿä¿®æ­£

**æ“ä½œæ­¥éª¤**ï¼š

1. **åˆ›å»ºä¿®æ­£è„šæœ¬** (å¦‚ `scripts/fix-report-{id}.js`)ï¼š
```javascript
const { querySqlite, sqlValue } = require('../dist/config/sqlite');

// è·å–æŠ¥å‘Šæ•°æ®
const versionId = 25; // æ›¿æ¢ä¸ºå®é™…çš„ version_id
const result = querySqlite(
  `SELECT parsed_json FROM report_versions WHERE id = ${versionId} LIMIT 1`
)[0];

// è§£æ JSON
const parsed = typeof result.parsed_json === 'string' 
  ? JSON.parse(result.parsed_json) 
  : result.parsed_json;

// ä¿®æ­£æ•°æ®
const table4 = parsed.sections.find(s => s.type === 'table_4');
table4.reviewLitigationData.litigationDirect.other = 10; // ä¿®æ­£å€¼
table4.reviewLitigationData.litigationDirect.total = 12; // ä¿®æ­£å€¼

// ä¿å­˜
const updatedJson = JSON.stringify(parsed);
querySqlite(`
  UPDATE report_versions
  SET parsed_json = ${sqlValue(updatedJson)}
  WHERE id = ${versionId};
`);

console.log('âœ… æ•°æ®å·²ä¿®æ­£');
```

2. **æ‰§è¡Œä¿®æ­£**ï¼š
```bash
node scripts/fix-report-{id}.js
```

3. **é‡æ–°è¿è¡Œæ ¡éªŒ**ï¼š
```bash
curl -Method POST http://localhost:8787/api/reports/33/checks/run
```

4. **éªŒè¯ç»“æœ**ï¼š
```bash
curl http://localhost:8787/api/reports/33/checks
```

---

### æ–¹æ¡ˆäºŒï¼šé‡æ–°è§£ææŠ¥å‘Š

**é€‚ç”¨åœºæ™¯**ï¼š
- å¤§èŒƒå›´è§£æé”™è¯¯
- å¤šä¸ªè¡¨æ ¼éƒ½æœ‰é—®é¢˜
- LLM æç¤ºè¯éœ€è¦ä¼˜åŒ–

**æ“ä½œæ­¥éª¤**ï¼š

1. **åˆ é™¤æ—§çš„è§£æç»“æœ**ï¼š
```javascript
// ä»…åˆ é™¤ parsed_jsonï¼Œä¿ç•™æ–‡ä»¶
querySqlite(`
  UPDATE report_versions
  SET parsed_json = NULL
  WHERE id = 25;
`);

// åˆ é™¤æ—§çš„ parse job
querySqlite(`
  DELETE FROM jobs
  WHERE version_id = 25 AND kind = 'parse';
`);
```

2. **è§¦å‘é‡æ–°è§£æ**ï¼š
```bash
# éœ€è¦åˆ›å»ºæ–°çš„ parse job
curl -Method POST http://localhost:8787/api/reports/33/reparse
```

**æ³¨æ„**ï¼š
- é‡æ–°è§£æä¼šæ¶ˆè€— LLM API é¢åº¦
- è§£ææ—¶é—´è¾ƒé•¿ï¼ˆé€šå¸¸ 10-30 ç§’ï¼‰
- ä¸ä¿è¯è§£å†³é—®é¢˜ï¼ˆå¯èƒ½ä»éœ€æ‰‹åŠ¨ä¿®æ­£ï¼‰

---

### æ–¹æ¡ˆä¸‰ï¼šä¼˜åŒ– LLM æç¤ºè¯åé‡æ–°è§£æ

**é€‚ç”¨åœºæ™¯**ï¼š
- åŒç±»é”™è¯¯åå¤å‡ºç°
- ç‰¹å®šå­—æ®µç»å¸¸è§£æé”™è¯¯
- éœ€è¦æå‡æ•´ä½“è§£æè´¨é‡

**æ“ä½œæ­¥éª¤**ï¼š

1. **ä¿®æ”¹ GeminiLlmProvider.ts çš„æç¤ºè¯**ï¼š
```typescript
// src/services/GeminiLlmProvider.ts
// åœ¨è¡¨å››éƒ¨åˆ†æ·»åŠ æ›´æ˜ç¡®çš„æŒ‡ç¤º
{
  "title": "å››ã€æ”¿åºœä¿¡æ¯å…¬å¼€è¡Œæ”¿å¤è®®ã€è¡Œæ”¿è¯‰è®¼æƒ…å†µ",
  "type": "table_4",
  "reviewLitigationData": {
    "review": { 
      "maintain": ..., 
      "correct": ..., 
      "other": ...,  // æ³¨æ„ï¼šå¯èƒ½æ˜¯ä¸¤ä½æ•°
      "unfinished": ..., 
      "total": ...   // å¿…é¡»ç­‰äºå‰å››é¡¹ä¹‹å’Œ
    },
    // ...
  }
}
```

2. **é‡æ–°ç¼–è¯‘**ï¼š
```bash
npm run build
```

3. **é‡å¯æœåŠ¡**ï¼š
```bash
npm run stop:llm
npm run start:llm
```

4. **æ‰¹é‡é‡æ–°è§£æ**ï¼š
```bash
node scripts/batch-reparse-all.js
```

---

## ğŸ“Š é‡‘æ¹–å¿æ¡ˆä¾‹æ€»ç»“

**å‘ç°çš„é”™è¯¯**ï¼š
- è¡¨å››"è¡Œæ”¿è¯‰è®¼-æœªç»å¤è®®"æ•°æ®ï¼š
  - `other`: åº”ä¸º 10ï¼Œè§£ææˆäº† 1
  - `total`: åº”ä¸º 12ï¼Œè§£ææˆäº† 0

**åŸå› åˆ†æ**ï¼š
å¯èƒ½æ˜¯ OCR è¯†åˆ«é—®é¢˜æˆ–è¡¨æ ¼åˆ—å¯¹é½é—®é¢˜

**è§£å†³æ–¹æ³•**ï¼š
ä½¿ç”¨æ–¹æ¡ˆä¸€æ‰‹åŠ¨ä¿®æ­£ï¼ˆè€—æ—¶ < 1 åˆ†é’Ÿï¼‰

**ä¿®æ­£å‰æ ¡éªŒç»“æœ**ï¼š
- âŒ 1 ä¸ª FAILï¼ˆè¡¨å››æ±‚å’Œä¸ä¸€è‡´ï¼‰

**ä¿®æ­£åæ ¡éªŒç»“æœ**ï¼š
- âœ… 0 ä¸ª FAIL
- âœ… æ‰€æœ‰æ•°æ®é€šè¿‡æ ¡éªŒ

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨ä¿®æ­£**ï¼šå¯¹äºå°‘é‡é”™è¯¯ï¼Œæ‰‹åŠ¨ä¿®æ­£æœ€å¿«æœ€å¯é 

2. **è®°å½•ä¿®æ­£å†å²**ï¼šæ¯æ¬¡ä¿®æ­£éƒ½åˆ›å»ºç‹¬ç«‹è„šæœ¬ï¼Œä¾¿äºè¿½æº¯

3. **ä¿®æ­£åå¿…é¡»é‡æ–°æ ¡éªŒ**ï¼šç¡®ä¿ä¿®æ­£çš„æ•°æ®é€šè¿‡ä¸€è‡´æ€§æ ¡éªŒ

4. **æ‰¹é‡é—®é¢˜è€ƒè™‘ä¼˜åŒ–æç¤ºè¯**ï¼šå¦‚æœåŒç±»é”™è¯¯é¢‘ç¹å‡ºç°ï¼Œè¯´æ˜éœ€è¦ä¼˜åŒ– LLM æç¤ºè¯

5. **ä¿ç•™åŸå§‹æ–‡ä»¶**ï¼šæ— è®ºå¦‚ä½•ä¿®æ­£ï¼Œå§‹ç»ˆä¿ç•™åŸå§‹ PDF æ–‡ä»¶

---

## ğŸ” å¦‚ä½•å‘ç°è§£æé”™è¯¯

1. **ä¸€è‡´æ€§æ ¡éªŒå‘ç°**ï¼šç³»ç»Ÿè‡ªåŠ¨æ£€æŸ¥å‹¾ç¨½å…³ç³»
2. **äººå·¥æŠ½æŸ¥å¯¹æ¯”**ï¼šéšæœºæŠ½å–æŠ¥å‘Šä¸åŸå§‹ PDF å¯¹æ¯”
3. **è·¨å¹´åº¦å¯¹æ¯”**ï¼šåŒä¸€åœ°åŒºä¸åŒå¹´åº¦æ•°æ®å¯¹æ¯”å¼‚å¸¸å€¼

---

*ç”Ÿæˆæ—¶é—´: 2025-12-25*
*é€‚ç”¨ç‰ˆæœ¬: v1.0.0+*
