# 新功能测试指南

## 📋 功能概述

已成功添加两个新功能到报告详情页面：

### 1. 勾稽关系校验显示
- 在报告详情页面添加"勾稽关系校验"标签页
- 显示所有一致性校验结果（FAIL、UNCERTAIN、PASS）
- 支持人工复核操作（确认问题、忽略、恢复待复核）
- 支持重新运行校验

### 2. 解析数据编辑功能
- 支持手动编辑表格数据（Table 2、3、4）
- 支持编辑文字内容（各section）
- 保存后自动更新parsed_json
- 提示用户重新运行一致性校验

---

## 🚀 测试步骤

### 准备工作
1. **确保服务运行**
   ```bash
   npm run health:llm  # 应返回 {"status":"ok"}
   ```

2. **访问前端**
   - 打开浏览器：http://localhost:3001
   - 进入报告列表
   - 点击"金湖县 2023年"报告（Report ID: 33）

### 测试场景1：查看勾稽关系校验结果

1. 在报告详情页，点击"🧮 勾稽关系校验"标签页
2. 如果尚未运行校验，点击"运行校验"按钮
3. 等待3秒后页面自动刷新，查看校验结果：
   - 应显示汇总信息（失败数、待复核数等）
   - 展开各组（表3校验、表4校验、文本一致性校验）
   - 查看具体校验项的详细信息

4. **验证功能**：
   - ✅ 校验项是否显示正确的状态（FAIL/UNCERTAIN/PASS）
   - ✅ 公式、左值、右值、差值是否正确显示
   - ✅ 证据（JSON路径）是否可展开查看
   - ✅ 人工复核按钮（确认问题、忽略、恢复待复核）是否可用

### 测试场景2：手动编辑解析数据

#### 背景
之前金湖县报告的Table 4存在解析错误：
- 行政诉讼"其他"列：1 应为 10
- 行政诉讼"合计"：0 应为 12

#### 测试步骤

1. **进入编辑模式**
   - 在报告详情页，点击"✏️ 编辑数据"按钮
   - 页面切换到编辑器界面

2. **编辑表格数据**
   - 在"表格数据"标签页，找到"表4: 政府信息公开行政复议、行政诉讼情况"
   - 找到"合计"行，修改"行政诉讼"部分的"其他"值：
     - 将 `1` 改为 `10`
   - 观察页面底部出现"⚠️ 您有未保存的修改"提示
   - 点击右上角"保存修改"按钮

3. **验证保存**
   - 应显示"保存成功！建议重新运行一致性校验。"提示
   - 页面自动退出编辑模式
   - 切换到"📄 年报内容"标签页，确认数据已更新

4. **重新校验**
   - 切换到"🧮 勾稽关系校验"标签页
   - 点击"重新校验"按钮
   - 等待3秒后查看结果：
     - 失败数应减少（之前的Table 4错误应消失）
     - 相关校验项状态应变为PASS

### 测试场景3：编辑文字内容

1. 点击"✏️ 编辑数据"按钮进入编辑模式
2. 切换到"文字内容"标签页
3. 编辑某个section的文本（如"其他需要报告的事项"）
4. 保存并验证修改是否生效

---

## 🎯 验证要点

### 功能完整性
- [ ] 勾稽关系校验标签页正常显示
- [ ] 校验结果分组展示（表3、表4、文本）
- [ ] 人工复核操作（确认/忽略/恢复）正常工作
- [ ] 编辑模式可正常进入和退出
- [ ] 表格数据可编辑（Table 2/3/4）
- [ ] 文字内容可编辑
- [ ] 保存后数据立即生效

### 用户体验
- [ ] 标签页切换流畅
- [ ] 编辑器界面清晰易用
- [ ] 保存/取消操作有明确反馈
- [ ] 未保存修改有警告提示
- [ ] 编辑后提示重新运行校验

### 数据一致性
- [ ] 编辑后parsed_json正确更新
- [ ] 重新校验能反映最新数据
- [ ] 人工复核状态正确保存
- [ ] 刷新页面后数据不丢失

---

## 🐛 已知问题和注意事项

1. **前端端口占用**
   - 如果前端未运行，手动启动：
     ```bash
     cd frontend
     npm start
     ```
   - 如果提示端口占用，先停止旧进程

2. **后端重启**
   - 修改代码后需重新编译并重启：
     ```bash
     npm run build
     npm run stop:llm
     npm run start:llm
     ```

3. **校验延迟**
   - 运行校验后等待3秒才会看到结果
   - 如果结果未显示，手动刷新页面

4. **编辑限制**
   - 目前仅支持编辑数值型字段和文本内容
   - 不支持添加/删除表格行
   - 复杂嵌套结构可能需要在JSON视图中编辑

---

## 📊 预期结果

### 金湖县报告（ID: 33）修复前后对比

#### 修复前
- 失败校验项：1个
- 问题：Table 4 行政诉讼"其他"合计不正确

#### 修复后（手动编辑后）
- 失败校验项：0个
- 所有校验项应为PASS或UNCERTAIN

---

## 🔧 技术细节

### 新增组件
1. **ConsistencyCheckView.js**
   - 显示勾稽关系校验结果
   - 支持人工复核操作
   - 集成到ReportDetail标签页

2. **ParsedDataEditor.js**
   - 表格数据编辑器（Table 2/3/4）
   - 文本内容编辑器
   - 保存时调用PATCH /api/reports/:id/parsed-data

### 后端API
- **PATCH /api/reports/:id/parsed-data**
  - 接收更新后的parsed_json
  - 更新active version的数据
  - 返回成功消息

### 数据库
- 使用SQLite本地数据库（data/llm_ingestion.db）
- 修改后的数据持久化到report_versions表

---

## 📝 反馈

测试时如发现问题，请记录以下信息：
1. 操作步骤
2. 预期结果
3. 实际结果
4. 浏览器控制台错误信息（F12 -> Console）
5. 网络请求信息（F12 -> Network）

---

**测试愉快！** 🎉
