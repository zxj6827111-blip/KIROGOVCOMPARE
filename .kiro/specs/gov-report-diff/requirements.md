# 政府信息公开年度报告差异比对系统 - 需求文档

## 介绍

政府信息公开年度报告差异比对系统是一个Web工具，用于帮助用户快速识别和分析两份政务公开年报之间的差异。系统支持用户上传PDF文件或提供URL，通过后台异步处理进行文档解析、结构化、差异比对，最终生成详细的对比报告。系统还提供AI建议功能，帮助用户理解差异点并识别可疑变化。

## 术语表

- **年报（Annual Report）**: 政府信息公开年度报告，通常为PDF格式
- **差异比对（Diff Comparison）**: 对两份年报进行逐章节、逐段落的内容对比
- **结构化（Structuring）**: 将PDF文档解析为标题、章节、段落、表格等结构化元素
- **任务（Task）**: 一次完整的比对操作，包括上传、处理、结果生成
- **差异摘要（Diff Summary）**: 对比结果的高层概览，包括变化最多的章节和关键数字变化
- **AI建议（AI Suggestion）**: 基于差异分析生成的智能建议，包括解读、风险提示和改进建议
- **任务状态（Task Status）**: queued（待处理）、running（处理中）、succeeded（成功）、failed（失败）
- **警告（Warning）**: 不影响核心结果产出，但影响结果完整性/准确性的非致命问题；任务仍可 succeeded
- **降级（Degraded）**: 因解析/对齐等原因触发的功能退化（如表格未解析、表格对齐不完全），以 warnings 呈现
- **年报资产（Report Asset）**: 入库的PDF文件记录，包含文件存储、元数据、可用性标记，可被多个任务引用
- **资产ID（assetId）**: 年报资产的唯一标识符，用于追溯源文件和支持复用
- **摄入（Ingesting）**: 接收输入并落盘/入库（上传或下载后的入库）
- **下载（Downloading）**: 仅URL场景，从远程服务器下载文件

## 权限与角色

- **普通用户**: 可直接上传发起比对、查看自己的任务历史、使用资料库中有权限的资产
- **管理员**: 可执行资料库批量入库、元数据管理、批量比对等管理操作

## 需求

### 需求 1：直接上传发起比对

**用户故事：** 作为用户，我想通过上传两份年报文件直接发起一次比对任务，以便快速发现两份文档之间的差异。

#### 验收标准

1. WHEN 用户在上传界面选择两份PDF文件 THEN 系统 SHALL 接受文件并创建一个新的比对任务
2. WHEN 用户提供两个年报的URL THEN 系统 SHALL 下载文件并创建比对任务
3. WHEN 用户上传文件时 THEN 系统 SHALL 验证文件格式（PDF）并拒绝无效文件
4. WHEN 用户仅提供一份文件或一个URL THEN 系统 SHALL 提示必须提供两份年报来源后才能创建任务
5. WHEN 用户通过上传或URL发起比对 THEN 系统 SHALL 为两份文件分别创建/复用 Report Asset，并在任务中记录 assetId_A/assetId_B 以支持追溯与复用
6. WHEN 资产复用时 THEN 系统 SHALL 以文件哈希为准，不以 URL 字符串为准；同 URL 下载内容变化应生成新版本资产
7. WHEN 任务创建成功 THEN 系统 SHALL 返回唯一的任务ID供用户追踪

### 需求 2：后台异步处理

**用户故事：** 作为用户，我想在后台异步处理大型PDF文件，以便不阻塞前端界面。

#### 验收标准

1. WHEN 任务被创建 THEN 系统 SHALL 将其状态设置为 queued
2. WHEN 系统开始处理任务 THEN 系统 SHALL 更新状态为 running
3. WHEN 处理完成 THEN 系统 SHALL 更新状态为 succeeded 或 failed
4. WHEN 用户查询任务状态 THEN 系统 SHALL 返回当前状态、处理阶段（ingesting/downloading/parsing/structuring/diffing/summarizing/exporting）、进度百分比、处理消息和警告列表
5. WHEN 处理过程中发生非致命错误 THEN 系统 SHALL 在警告列表中记录，继续处理而不中断
6. WHEN 系统返回进度百分比 THEN progress SHALL 单调不减；succeeded 时 MUST 为 100；failed 时保持在失败点；阶段切换时 progress 至少增加 1%
7. WHEN 系统返回警告列表 THEN 每条 warning SHALL 至少包含：code、message、stage（可选含 affectedAssetId/section/tableId），便于前端定位和用户理解
8. 注：并非所有阶段都会出现（例如直接上传没有 downloading；有缓存复用可能跳过 parsing/structuring），前端不应将缺阶段视为异常

### 需求 3：文档解析与结构化

**用户故事：** 作为系统，我需要将PDF文档解析为结构化格式，以便进行精确的差异比对。

#### 验收标准

1. WHEN 系统处理PDF文件 THEN 系统 SHALL 提取标题、章节层级、段落和表格
2. WHEN 提取表格 THEN 系统 SHALL 尽力保留表格的行列结构和单元格内容，若失败则标注"表格结构解析失败"
3. WHEN 文本解析失败 THEN 系统 SHALL 记录错误并将任务状态设置为 failed
4. WHEN 仅表格解析失败但文本解析成功 THEN 系统 SHALL 继续处理，在结果中标注"表格未解析"，任务状态为 succeeded
5. WHEN 文档结构化完成 THEN 系统 SHALL 生成结构化数据模型供后续比对使用

### 需求 4：差异比对 - 正文内容

**用户故事：** 作为用户，我想看到两份年报正文中的具体差异，包括新增、删除和修改的内容。

#### 验收标准

1. WHEN 系统比对两份文档 THEN 系统 SHALL 识别新增段落并标记为"新增"
2. WHEN 系统比对两份文档 THEN 系统 SHALL 识别删除的段落并标记为"删除"
3. WHEN 系统比对两份文档 THEN 系统 SHALL 识别修改的段落并标记为"修改"，显示修改前后内容
4. WHEN 显示差异 THEN 系统 SHALL 按章节和段落层级组织结果，便于用户定位

### 需求 5：差异比对 - 表格内容

**用户故事：** 作为用户，我想看到表格中的具体变化，包括单元格文本的修改。

#### 验收标准

1. WHEN 系统比对表格 THEN 系统 SHALL 尽力识别表格结构变化（行列增删/表格新增或删除），若无法可靠对齐则标注"表格结构对齐不完全"并仍展示可对比内容
2. WHEN 系统比对表格 THEN 系统 SHALL 识别单元格文本变化并标记显示
3. WHEN 显示表格差异 THEN 系统 SHALL 清晰标记哪些单元格被修改、新增或删除
4. WHEN 用户查看表格差异 THEN 系统 SHALL 提供原表格和修改后表格的对比视图

### 需求 6：差异摘要生成

**用户故事：** 作为用户，我想快速了解两份年报的主要差异，包括变化最多的章节和关键数字变化。

#### 验收标准

1. WHEN 比对完成 THEN 系统 SHALL 生成差异摘要，列出变化最多的前N个章节（默认N=5，可配置）
2. WHEN 生成摘要 THEN 系统 SHALL 识别并突出显示关键数字的变化（如统计数据、百分比）
3. WHEN 生成摘要 THEN 系统 SHALL 计算总体差异统计（新增段落数、删除段落数、修改段落数、表格变更数量）
4. WHEN 用户查看摘要 THEN 系统 SHALL 提供清晰的可视化展示

### 需求 7：结果展示 - 网页查看

**用户故事：** 作为用户，我想在网页上查看详细的对比结果，包括正文和表格的差异。

#### 验收标准

1. WHEN 任务完成 THEN 系统 SHALL 在网页上展示完整的对比报告
2. WHEN 用户浏览报告 THEN 系统 SHALL 支持按章节导航和搜索功能
3. WHEN 用户查看差异 THEN 系统 SHALL 使用清晰的差异标识（新增/删除/修改标签与高亮样式）；颜色编码可作为辅助但不作为唯一识别方式
4. WHEN 用户点击差异项 THEN 系统 SHALL 显示修改前后的完整内容对比

### 需求 8：结果导出 - DOCX格式

**用户故事：** 作为用户，我想下载对比报告为DOCX格式，以便离线查看和分享。

#### 验收标准

1. WHEN 任务处理成功 THEN 系统 SHALL 自动生成DOCX格式的对比报告
2. WHEN 生成DOCX THEN 系统 SHALL 包含差异摘要、详细对比内容和表格对比
3. WHEN 生成DOCX THEN 系统 SHALL 使用清晰的格式和样式，便于阅读
4. WHEN 用户下载报告 THEN 系统 SHALL 提供有意义的文件名（如 diff_report_[taskId].docx）
5. WHEN AI建议已生成 THEN 系统 SHALL 额外生成并提供下载包含AI建议的DOCX报告（例如 diff_report_with_ai_[taskId].docx），原对比报告保持不变
6. WHEN 差异结果已生成但DOCX导出失败 THEN 系统 SHALL 保持任务为 succeeded，报告页可查看；同时在 warnings 标注"DOCX导出失败"并允许重新导出

### 需求 9：历史记录管理

**用户故事：** 作为用户，我想查看之前的所有比对任务，以便快速访问历史报告。

#### 验收标准

1. WHEN 用户访问历史记录页面 THEN 系统 SHALL 显示所有过去的比对任务列表
2. WHEN 用户查看列表 THEN 系统 SHALL 显示任务ID、创建时间、文件名、状态和摘要
3. WHEN 用户点击历史任务 THEN 系统 SHALL 显示该任务的详细对比结果
4. WHEN 用户查看历史任务 THEN 系统 SHALL 支持重新下载对比报告

### 需求 10：AI建议功能 - 异步生成与缓存

**用户故事：** 作为用户，我想按需获得AI生成的建议来理解差异点，系统应缓存结果以节省成本。

#### 验收标准

1. WHEN 用户查看历史任务详情 THEN 系统 SHALL 显示"生成AI建议"按钮
2. WHEN 用户点击按钮 THEN 系统 SHALL 异步生成AI建议，返回建议状态（queued/running/succeeded/failed）
3. WHEN AI建议已生成 THEN 系统 SHALL 缓存结果，后续查询直接返回缓存而不重新调用AI服务
4. WHEN 用户再次点击按钮且缓存存在 THEN 系统 SHALL 返回缓存的建议
5. WHEN 用户点击"强制重新生成"按钮 THEN 系统 SHALL 清除缓存并重新生成建议
6. WHEN AI建议生成失败 THEN 系统 SHALL 显示失败原因，允许用户重试
7. 注：AI建议状态与结果归属 compareTaskId，便于追溯和关联查询

### 需求 11：AI建议内容

**用户故事：** 作为用户，我想了解差异点的含义、潜在风险和改进建议。

#### 验收标准

1. WHEN AI建议生成完成 THEN 系统 SHALL 提供差异点的解读说明
2. WHEN 生成建议 THEN 系统 SHALL 识别可疑点并提示需要人工复核的内容（保守措辞）
3. WHEN 生成建议 THEN 系统 SHALL 提供规范性改进建议
4. WHEN 生成建议 THEN 系统 SHALL 基于差异结果和摘要而非整篇全文，以控制成本，输入限制为：按章节Top N的差异、截断到最大字符数（可配置）
5. WHEN 用户查看建议 THEN 系统 SHALL 支持下载包含建议的DOCX报告

### 需求 12：失败与降级策略

**用户故事：** 作为系统，我需要优雅地处理解析失败和其他错误，确保用户能获得有用的结果。

#### 验收标准

1. WHEN 表格解析失败但文本解析成功 THEN 系统 SHALL 继续处理，在结果中标注"表格未解析"，任务状态为 succeeded
2. WHEN 文本解析失败 THEN 系统 SHALL 将任务状态设置为 failed，返回用户可读的错误信息
3. WHEN URL抓取失败或超时 THEN 系统 SHALL 返回用户可读的错误信息，包括失败原因
4. WHEN 用户重试失败的任务 THEN 系统 SHALL 创建新的比对任务ID，并在新任务中引用原任务ID为 retryOf，历史记录中两者均可追溯

### 需求 13：输入约束与校验

**用户故事：** 作为系统，我需要验证用户输入，防止无效或恶意请求。

#### 验收标准

1. WHEN 用户上传文件 THEN 系统 SHALL 验证文件类型为PDF，拒绝其他格式
2. WHEN 用户上传文件 THEN 系统 SHALL 检查文件大小在允许范围内（建议≤100MB）
3. WHEN 用户上传加密或损坏的PDF THEN 系统 SHALL 返回明确的错误提示
4. WHEN 用户提供URL THEN 系统 SHALL 验证URL格式，仅允许HTTP/HTTPS协议
5. WHEN 用户提供URL THEN 系统 SHALL 防止SSRF攻击，拒绝内网地址（如127.0.0.1、192.168.x.x、10.x.x.x）
6. WHEN URL请求发生重定向 THEN 系统 SHALL 对重定向后的最终地址再次执行协议与内网地址校验
7. WHEN URL请求发生重定向 THEN 系统 SHALL 限制重定向次数≤N（可配置），且仅允许 HTTPS→HTTPS 或 HTTP→HTTPS（禁止降级到 HTTP）
8. WHEN 下载URL文件 THEN 系统 SHALL 设置合理的超时时间（connect/read timeout）和最大下载大小（≤100MB）
9. WHEN 下载URL文件 THEN 系统 SHALL 校验content-type和文件签名，防止下载到非PDF内容

### 需求 14：历史记录数据保存

**用户故事：** 作为系统，我需要完整保存历史记录，支持可追溯性和复现。

#### 验收标准

1. WHEN 任务完成 THEN 系统 SHALL 保存原文件引用/存储路径、解析后的结构化JSON、比对结果JSON
2. WHEN 任务完成 THEN 系统 SHALL 保存导出的DOCX路径、生成时间和版本号
3. WHEN 用户查询历史记录 THEN 系统 SHALL 支持按创建时间、文件名、状态等条件筛选
4. WHEN 用户删除历史记录（Task）THEN 系统 SHALL 删除该任务的比对结果、导出文件、AI建议（若存在）
5. 注：解析缓存以 assetId 为粒度共享，不随任务删除；源文件资产由后台GC按策略清理

### 需求 15：差异摘要规范

**用户故事：** 作为用户，我想获得标准化的差异摘要，清晰了解主要变化。

#### 验收标准

1. WHEN 生成摘要 THEN 系统 SHALL 列出变更最多的前N个章节（默认N=5，可配置）
2. WHEN 生成摘要 THEN 系统 SHALL 统计新增段落数、删除段落数、修改段落数
3. WHEN 生成摘要 THEN 系统 SHALL 统计表格变更数量（新增表格、删除表格、修改表格）
4. WHEN 生成摘要 THEN 系统 SHALL 提取关键数字变化列表（如统计数据、百分比、金额）
5. WHEN 无差异或差异很少 THEN 系统 SHALL 显示"两份文档基本一致"或"仅有轻微差异"的提示


### 需求 16：年报资料库 - 批量上传与入库

**用户故事：** 作为管理员，我想批量上传一批PDF年报到资料库中保存，以便后续由前端发起比对申请时再使用这些已入库的年报。

#### 验收标准

1. WHEN 管理员批量上传多个PDF THEN 系统 SHALL 将每个文件保存为"年报资产（Report Asset）"记录并存储文件，不自动创建比对任务
2. WHEN 入库成功 THEN 系统 SHALL 为每个资产生成唯一 assetId，并记录文件名、大小、上传时间、上传人、文件哈希（用于去重）
3. WHEN 上传文件重复（哈希一致）THEN 系统 SHALL 支持去重策略（默认：哈希一致则复用并提示"已存在"；允许管理员选择"保留为新版本"）
4. WHEN 上传过程中部分文件失败 THEN 系统 SHALL 返回逐文件结果（成功/失败原因），成功部分可用
5. WHEN 管理员查看资料库 THEN 系统 SHALL 支持按年份/地区/部门/上传时间/文件名搜索筛选（元数据可为空但可后续补全）

### 需求 17：年报资料库 - 元数据管理与可用性校验

**用户故事：** 作为管理员，我想为入库的年报补充或修正元数据（地区、部门、年份等），并标识该文件是否可用于比对。

#### 验收标准

1. WHEN 资产入库 THEN 系统 SHALL 尝试从文件名或内容启发式提取年份等元数据（失败不影响入库）
2. WHEN 管理员编辑资产 THEN 系统 SHALL 允许维护字段：年份、地区/部门、报告类型/备注、标签、版本号（可选）
3. WHEN PDF为加密/损坏导致无法读取正文 THEN 系统 SHALL 将资产标记为不可用（unusable）并给出原因，但仍保留资产记录
4. WHEN 资产可用 THEN 系统 SHALL 标记为 usable，可被前端用于创建比对任务

### 需求 18：基于资料库发起比对申请

**用户故事：** 作为用户，我想从资料库选择两份已入库年报发起比对，以便系统异步生成差异结果与报告。

#### 验收标准

1. WHEN 用户在前端选择两个 assetId THEN 系统 SHALL 创建比对任务（Task），并沿用需求2的异步状态机处理
2. WHEN 用户仅选择一个 assetId THEN 系统 SHALL 提示必须选择两份年报才能发起比对
3. WHEN 任一资产为 unusable THEN 系统 SHALL 阻止创建比对任务并提示原因
4. WHEN 任务创建成功 THEN 系统 SHALL 记录该任务引用的 assetId_A/assetId_B，历史记录可追溯到源文件

### 需求 19：管理员批量比对

**用户故事：** 作为管理员，我想对资料库中的一批年报按规则批量创建比对任务并执行，以便内部集中生产比对结果。

#### 验收标准

1. WHEN 管理员选择一批资产并指定批量规则 THEN 系统 SHALL 生成多条比对任务（每对一条 taskId），并进入异步处理队列
2. WHEN 批量规则为"同地区/同部门跨年配对" THEN 系统 SHALL 支持按年份自动配对（例如 2024 vs 2025），并允许管理员在提交前预览与手动调整配对
3. WHEN 存在无法配对的资产 THEN 系统 SHALL 给出未配对清单与原因（缺年份/缺地区/重复/冲突）
4. WHEN 同一地区/部门/年份存在多个可用资产版本 THEN 系统 SHALL 默认选择上传时间最新的资产参与自动配对，其余进入冲突清单供人工处理
5. WHEN 批量任务执行 THEN 系统 SHALL 提供批量进度视图与导出清单（taskId、状态、下载链接）

### 需求 20：解析结果缓存复用

**用户故事：** 作为系统，我需要缓存已解析的文档结构，以便同一资产多次比对时避免重复解析。

#### 验收标准

1. WHEN 资产首次被用于比对 THEN 系统 SHALL 执行完整的解析流程，并缓存结构化结果
2. WHEN 同一资产被再次用于比对 THEN 系统 SHALL 复用缓存的结构化结果，跳过重复解析
3. WHEN 资产源文件内容更新（新版本文件或文件哈希变化）或解析算法版本（parseVersion）更新 THEN 系统 SHALL 清除相关解析缓存，下次比对时重新解析
4. WHEN 管理员批量比对时 THEN 系统 SHALL 利用解析缓存提升吞吐和降低成本
5. 注：元数据更新（如年份、地区、标签）不触发清缓存，仅源文件或解析算法变化时清缓存

### 需求 21：AI建议缓存版本管理

**用户故事：** 作为系统，我需要管理AI建议的缓存版本，以便在AI模型或参数更新时能够重新生成。

#### 验收标准

1. WHEN AI建议被缓存 THEN 系统 SHALL 记录 aiConfigVersion（MVP 可固定为 1）
2. WHEN 用户请求AI建议 THEN 系统 SHALL 检查缓存键：compareTaskId + aiConfigVersion
3. WHEN aiConfigVersion 更新 THEN 系统 SHALL 将旧版本缓存视为未命中（不会被返回）；可通过后台GC策略清理旧版本缓存
4. WHEN 用户点击"强制重新生成" THEN 系统 SHALL 清除缓存并使用最新 aiConfigVersion 重新生成
